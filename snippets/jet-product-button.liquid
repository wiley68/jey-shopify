{% if product and product.selected_or_first_available_variant %}
  {% if settings.jet_status_in and shop.currency == 'EUR' %}
    {% assign product_price = product.selected_or_first_available_variant.price | divided_by: 100.0 %}
    {% if product_price < settings.jet_minprice %}
      {% comment %}Цената е по-малка от минималната, не показваме нищо{% endcomment %}
    {% else %}
      {{ 'jet_product.css' | asset_url | stylesheet_tag }}
      <script src="{{ 'jet_product.js' | asset_url }}" defer></script>

      {% assign jet_email_pbpf_valid = false %}
      {% if settings.jet_email_pbpf != blank %}
        {% assign jet_email_pbpf_trimmed = settings.jet_email_pbpf | strip %}
        {% if jet_email_pbpf_trimmed != blank %}
          {% unless jet_email_pbpf_trimmed contains ',' %}
            {% if jet_email_pbpf_trimmed contains '@' and jet_email_pbpf_trimmed contains '.' %}
              {% assign jet_email_pbpf_valid = true %}
            {% endif %}
          {% endunless %}
        {% endif %}
      {% endif %}

      {% assign jet_email_shop_valid = false %}
      {% if settings.jet_email_shop != blank %}
        {% assign jet_email_shop_trimmed = settings.jet_email_shop | strip %}
        {% if jet_email_shop_trimmed != blank %}
          {% unless jet_email_shop_trimmed contains ',' %}
            {% if jet_email_shop_trimmed contains '@' and jet_email_shop_trimmed contains '.' %}
              {% assign jet_email_shop_valid = true %}
            {% endif %}
          {% endunless %}
        {% endif %}
      {% endif %}

      {% assign jet_id_valid = false %}
      {% if settings.jet_id != blank %}
        {% assign jet_id_trimmed = settings.jet_id | strip %}
        {% if jet_id_trimmed != blank %}
          {% assign jet_id_valid = true %}
        {% endif %}
      {% endif %}

      {% if jet_email_pbpf_valid and jet_email_shop_valid and jet_id_valid %}
        {% comment %}Изчисляване на вноските{% endcomment %}
        {% assign jet_parva = 0 %}
        {% assign jet_total_credit_price = product_price | minus: jet_parva %}
        {% assign jet_min_vnoski = 125 %}
        {% if jet_total_credit_price < jet_min_vnoski %}
          {% assign jet_vnoski = 9 %}
        {% else %}
          {% assign jet_vnoski = settings.jet_vnoski_default %}
        {% endif %}
        {% comment %}Изчисляване на месечната вноска: jet_vnoska = (jet_total_credit_price / jet_vnoski) * (1 + (jet_vnoski * jet_purcent) / 100){% endcomment %}
        {% assign jet_vnoska_calc = jet_total_credit_price | divided_by: jet_vnoski | times: 1.0 %}
        {% assign jet_vnoska_multiplier = jet_vnoski | times: settings.jet_purcent | divided_by: 100.0 | plus: 1.0 %}
        {% assign jet_vnoska = jet_vnoska_calc | times: jet_vnoska_multiplier %}
        <div
          id="jet-product-button-container"
          class="jet-product-button"
          {% if settings.jet_gap > 0 %}
            style="--jet-gap: {{ settings.jet_gap }}px;"
          {% endif %}
          data-product-price="{{ product.selected_or_first_available_variant.price }}"
          data-variant-id="{{ product.selected_or_first_available_variant.id }}"
          data-jet-minprice="{{ settings.jet_minprice }}"
          data-jet-min-vnoski="{{ jet_min_vnoski }}"
          data-jet-vnoski-default="{{ settings.jet_vnoski_default }}"
          data-jet-vnoski="{{ jet_vnoski }}"
          data-jet-parva="{{ jet_parva }}"
          data-jet-purcent="{{ settings.jet_purcent }}"
        >
          <img
            src="{{ 'jet.png' | asset_url }}"
            alt="ПБ Лични Финанси"
            class="jet-product-button-img"
            width="200"
            height="69"
          >
        </div>
        {% if settings.jet_vnoska %}
          <div
            class="jet-vnoska-text jet-vnoska-regular"
            data-vnoski="{{ jet_vnoski }}"
            data-jet-purcent="{{ settings.jet_purcent }}"
          >
            {{ jet_vnoski }} x {{ jet_vnoska | round: 2 }} €
          </div>
        {% endif %}

        <!-- Popup прозорец за лизинг -->
        <div id="jet-popup-overlay" class="jet-popup-overlay" style="display: none;">
          <div class="jet-popup-container">
            <div class="jet-popup-content">
              <!-- Стъпка 1: Параметри на кредита (месеци, първоначална, вноска) -->
              <div id="jet-popup-step1" class="jet-popup-step">
                <!-- Ред 1: Първоначална вноска -->
                <div class="jet-popup-row">
                  <label class="jet-popup-label">Първоначална вноска (€)</label>
                  <div class="jet-popup-input-group">
                    <input
                      type="number"
                      id="jet-parva-input"
                      class="jet-popup-input"
                      min="0"
                      step="1"
                      value="0"
                    >
                    <button type="button" id="jet-recalculate-btn" class="jet-popup-btn">Преизчисли</button>
                  </div>
                </div>

                <!-- Ред 2: Цена на стоките -->
                <div class="jet-popup-row">
                  <label class="jet-popup-label">Цена на стоките (€)</label>
                  <input
                    type="text"
                    id="jet-product-price-input"
                    class="jet-popup-input jet-popup-input-readonly"
                    readonly
                    value="{{ product_price | round: 2 }}"
                  >
                </div>

                <!-- Ред 3: Брой погасителни вноски (custom dropdown за падинг в опциите) -->
                <div class="jet-popup-row">
                  <label class="jet-popup-label">Брой погасителни вноски</label>
                  <div class="jet-select-wrap">
                    <select id="jet-vnoski-select" class="jet-popup-select" aria-hidden="true" tabindex="-1">
                      <option value="3">3 месеца</option>
                      <option value="6">6 месеца</option>
                      <option value="9">9 месеца</option>
                      <option value="12" selected>12 месеца</option>
                      <option value="15">15 месеца</option>
                      <option value="18">18 месеца</option>
                      <option value="24">24 месеца</option>
                      <option value="30">30 месеца</option>
                      <option value="36">36 месеца</option>
                    </select>
                    <div id="jet-vnoski-display" class="jet-select-display" aria-label="Брой погасителни вноски"></div>
                    <div id="jet-vnoski-list" class="jet-select-list" role="listbox" hidden></div>
                  </div>
                </div>

                <!-- Ред 4: Общ размер на кредита -->
                <div class="jet-popup-row">
                  <label class="jet-popup-label">Общ размер на кредита (€)</label>
                  <input
                    type="text"
                    id="jet-total-credit-input"
                    class="jet-popup-input jet-popup-input-readonly"
                    readonly
                    value="{{ jet_total_credit_price | round: 2 }}"
                  >
                </div>

                <!-- Ред 5: Месечна вноска -->
                <div class="jet-popup-row">
                  <label class="jet-popup-label">Месечна вноска (€)</label>
                  <input
                    type="text"
                    id="jet-monthly-vnoska-input"
                    class="jet-popup-input jet-popup-input-readonly"
                    readonly
                    value="{{ jet_vnoska | round: 2 }}"
                  >
                </div>

                <!-- Ред 6: Фикс ГПР -->
                <div class="jet-popup-row">
                  <label class="jet-popup-label">Фикс ГПР (%)</label>
                  <input
                    type="text"
                    id="jet-fix-gpr-input"
                    class="jet-popup-input jet-popup-input-readonly"
                    readonly
                    value="0.00"
                  >
                </div>

                <!-- Ред 7: ГЛП -->
                <div class="jet-popup-row">
                  <label class="jet-popup-label">ГЛП (%)</label>
                  <input
                    type="text"
                    id="jet-glp-input"
                    class="jet-popup-input jet-popup-input-readonly"
                    readonly
                    value="0.00"
                  >
                </div>

                <!-- Ред 8: Обща стойност на плащанията -->
                <div class="jet-popup-row">
                  <label class="jet-popup-label">Обща стойност на плащанията (€)</label>
                  <input
                    type="text"
                    id="jet-total-payments-input"
                    class="jet-popup-input jet-popup-input-readonly"
                    readonly
                    value="{{ jet_vnoski | times: jet_vnoska | round: 2 }}"
                  >
                </div>

                <!-- Ред 9: Разделител и checkbox-ове -->
                <div class="jet-popup-divider"></div>
                <div class="jet-popup-row">
                  <label class="jet-popup-checkbox-label">
                    <input type="checkbox" id="jet-terms-checkbox" class="jet-popup-checkbox">
                    <a href="https://www.postbank.bg/common-conditions-PFBG" target="_blank" rel="noopener noreferrer"
                      >Запознах се с условията за кандидатстване на ПБ Лични финанси</a
                    >
                  </label>
                </div>
                <div class="jet-popup-row">
                  <label class="jet-popup-checkbox-label">
                    <input type="checkbox" id="jet-gdpr-checkbox" class="jet-popup-checkbox">
                    <a
                      href="https://www.postbank.bg/Personal-Data-PFBG-retailers"
                      target="_blank"
                      rel="noopener noreferrer"
                      >"GDPR" означава Регламент (ЕС) 2016/679 от 27 април 2016 г. за защита на физическите лица по
                      отношение на обработката на лични данни и за свободното движение на такива данни и за отмяна на
                      Директива 95/46 / ЕО</a
                    >
                  </label>
                </div>
              </div>

              <!-- Стъпка 2: (съдържанието ще се добави на следващ етап) -->
              <div id="jet-popup-step2" class="jet-popup-step" style="display: none;">
                <div class="jet-popup-step2-body">
                  <!-- Ред 1: Име -->
                  <div class="jet-popup-row">
                    <label class="jet-popup-label" for="jet-step2-firstname">Име *</label>
                    <input
                      type="text"
                      id="jet-step2-firstname"
                      class="jet-popup-input"
                      autocomplete="given-name"
                      required
                    >
                  </div>
                  <!-- Ред 2: Фамилия -->
                  <div class="jet-popup-row">
                    <label class="jet-popup-label" for="jet-step2-lastname">Фамилия *</label>
                    <input
                      type="text"
                      id="jet-step2-lastname"
                      class="jet-popup-input"
                      autocomplete="family-name"
                      required
                    >
                  </div>
                  <!-- Ред 3: ЕГН -->
                  <div class="jet-popup-row">
                    <label class="jet-popup-label" for="jet-step2-egn">ЕГН *</label>
                    <input
                      type="text"
                      id="jet-step2-egn"
                      class="jet-popup-input"
                      inputmode="numeric"
                      pattern="[0-9]{10}"
                      maxlength="10"
                      required
                    >
                  </div>
                  <!-- Ред 4: Мобилен телефон -->
                  <div class="jet-popup-row">
                    <label class="jet-popup-label" for="jet-step2-phone">Мобилен телефон *</label>
                    <input
                      type="tel"
                      id="jet-step2-phone"
                      class="jet-popup-input"
                      autocomplete="tel"
                      required
                    >
                  </div>
                  <!-- Ред 5: E-Mail -->
                  <div class="jet-popup-row">
                    <label class="jet-popup-label" for="jet-step2-email">E-Mail *</label>
                    <input
                      type="email"
                      id="jet-step2-email"
                      class="jet-popup-input"
                      autocomplete="email"
                      required
                    >
                  </div>

                  <div class="jet-popup-divider"></div>

                  <div class="jet-popup-row">
                    <label class="jet-popup-checkbox-label">
                      <input type="checkbox" id="jet-step2-terms-checkbox" class="jet-popup-checkbox">
                      <a
                        href="https://www.postbank.bg/common-conditions-PFBG"
                        target="_blank"
                        rel="noopener noreferrer"
                      >
                        Запознах се с условията за кандидатстване на ПБ Лични финанси *
                      </a>
                    </label>
                  </div>
                  <div class="jet-popup-row">
                    <a
                      href="https://www.postbank.bg/product-information-PBPG-retailers"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="jet-popup-link-text"
                    >
                      Продуктова Информация на ПБ Лични финанси
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <!-- Футър – отделна секция, от край до край -->
            <div class="jet-popup-footer">
              <div id="jet-popup-footer-step1" class="jet-popup-footer-inner">
                <div class="jet-popup-buttons">
                  <button type="button" id="jet-cancel-btn" class="jet-popup-btn">Откажи</button>
                  <button type="button" id="jet-add-to-cart-btn" class="jet-popup-btn">Добави в количката</button>
                  <button type="button" id="jet-buy-on-credit-btn" class="jet-popup-btn" disabled>
                    Купи на изплащане
                  </button>
                </div>
              </div>
              <div
                id="jet-popup-footer-step2"
                class="jet-popup-footer-inner jet-popup-footer-step2"
                style="display: none;"
              >
                <div class="jet-popup-buttons jet-popup-buttons-left">
                  <button type="button" id="jet-step2-back-btn" class="jet-popup-btn">Назад</button>
                </div>
                <div class="jet-popup-buttons jet-popup-buttons-right">
                  <button type="button" id="jet-step2-cancel-btn" class="jet-popup-btn">Откажи</button>
                  <span
                    class="jet-popup-submit-wrap"
                    id="jet-step2-submit-wrap"
                  >
                    <button type="button" id="jet-step2-submit-btn" class="jet-popup-btn" disabled>Изпрати</button>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        {% if settings.jet_card_in %}
          <div
            id="jet-product-button-card-container"
            class="jet-product-button"
            data-product-price="{{ product.selected_or_first_available_variant.price }}"
            data-jet-minprice="{{ settings.jet_minprice }}"
            data-jet-min-vnoski="{{ jet_min_vnoski }}"
            data-jet-vnoski-default="{{ settings.jet_vnoski_default }}"
            data-jet-parva="{{ jet_parva }}"
            data-jet-purcent-card="{{ settings.jet_purcent_card }}"
          >
            <img
              src="{{ 'jet_card.png' | asset_url }}"
              alt="ПБ Лични Финанси (кредитна карта)"
              class="jet-product-button-img"
              width="200"
              height="69"
            >
          </div>
          {% if settings.jet_vnoska %}
            {% comment %}Изчисляване на месечната вноска за кредитна карта{% endcomment %}
            {% assign jet_vnoska_card_calc = jet_total_credit_price | divided_by: jet_vnoski | times: 1.0 %}
            {% assign jet_vnoska_card_multiplier = jet_vnoski
              | times: settings.jet_purcent_card
              | divided_by: 100.0
              | plus: 1.0
            %}
            {% assign jet_vnoska_card = jet_vnoska_card_calc | times: jet_vnoska_card_multiplier %}
            <div
              class="jet-vnoska-text jet-vnoska-card"
              data-vnoski="{{ jet_vnoski }}"
              data-jet-purcent-card="{{ settings.jet_purcent_card }}"
            >
              {{ jet_vnoski }} x {{ jet_vnoska_card | round: 2 }} €
            </div>
          {% endif %}

          <!-- Popup прозорец за лизинг (кредитна карта) – същата логика, jet_purcent_card -->
          <div id="jet-popup-overlay-card" class="jet-popup-overlay" style="display: none;">
            <div class="jet-popup-container">
              <div class="jet-popup-content">
                <div id="jet-popup-step1-card" class="jet-popup-step">
                  <div class="jet-popup-row">
                    <label class="jet-popup-label">Първоначална вноска (€)</label>
                    <div class="jet-popup-input-group">
                      <input type="number" id="jet-parva-input-card" class="jet-popup-input" min="0" step="1" value="0">
                      <button type="button" id="jet-recalculate-btn-card" class="jet-popup-btn">Преизчисли</button>
                    </div>
                  </div>
                  <div class="jet-popup-row">
                    <label class="jet-popup-label">Цена на стоките (€)</label>
                    <input
                      type="text"
                      id="jet-product-price-input-card"
                      class="jet-popup-input jet-popup-input-readonly"
                      readonly
                      value="{{ product_price | round: 2 }}"
                    >
                  </div>
                  <div class="jet-popup-row">
                    <label class="jet-popup-label">Брой погасителни вноски</label>
                    <div class="jet-select-wrap">
                      <select id="jet-vnoski-select-card" class="jet-popup-select" aria-hidden="true" tabindex="-1">
                        <option value="3">3 месеца</option>
                        <option value="6">6 месеца</option>
                        <option value="9">9 месеца</option>
                        <option value="12" selected>12 месеца</option>
                        <option value="15">15 месеца</option>
                        <option value="18">18 месеца</option>
                        <option value="24">24 месеца</option>
                        <option value="30">30 месеца</option>
                        <option value="36">36 месеца</option>
                      </select>
                      <div
                        id="jet-vnoski-display-card"
                        class="jet-select-display"
                        aria-label="Брой погасителни вноски"
                      ></div>
                      <div id="jet-vnoski-list-card" class="jet-select-list" role="listbox" hidden></div>
                    </div>
                  </div>
                  <div class="jet-popup-row">
                    <label class="jet-popup-label">Общ размер на кредита (€)</label>
                    <input
                      type="text"
                      id="jet-total-credit-input-card"
                      class="jet-popup-input jet-popup-input-readonly"
                      readonly
                      value="{{ jet_total_credit_price | round: 2 }}"
                    >
                  </div>
                  <div class="jet-popup-row">
                    <label class="jet-popup-label">Месечна вноска (€)</label>
                    <input
                      type="text"
                      id="jet-monthly-vnoska-input-card"
                      class="jet-popup-input jet-popup-input-readonly"
                      readonly
                      value="{{ jet_vnoska_card | round: 2 }}"
                    >
                  </div>
                  <div class="jet-popup-row">
                    <label class="jet-popup-label">Фикс ГПР (%)</label>
                    <input
                      type="text"
                      id="jet-fix-gpr-input-card"
                      class="jet-popup-input jet-popup-input-readonly"
                      readonly
                      value="0.00"
                    >
                  </div>
                  <div class="jet-popup-row">
                    <label class="jet-popup-label">ГЛП (%)</label>
                    <input
                      type="text"
                      id="jet-glp-input-card"
                      class="jet-popup-input jet-popup-input-readonly"
                      readonly
                      value="0.00"
                    >
                  </div>
                  <div class="jet-popup-row">
                    <label class="jet-popup-label">Обща стойност на плащанията (€)</label>
                    <input
                      type="text"
                      id="jet-total-payments-input-card"
                      class="jet-popup-input jet-popup-input-readonly"
                      readonly
                      value="{{ jet_vnoski | times: jet_vnoska_card | round: 2 }}"
                    >
                  </div>
                  <div class="jet-popup-divider"></div>
                  <div class="jet-popup-row">
                    <label class="jet-popup-checkbox-label">
                      <input type="checkbox" id="jet-terms-checkbox-card" class="jet-popup-checkbox">
                      <a href="https://www.postbank.bg/common-conditions-PFBG" target="_blank" rel="noopener noreferrer"
                        >Запознах се с условията за кандидатстване на ПБ Лични финанси</a
                      >
                    </label>
                  </div>
                  <div class="jet-popup-row">
                    <label class="jet-popup-checkbox-label">
                      <input type="checkbox" id="jet-gdpr-checkbox-card" class="jet-popup-checkbox">
                      <a
                        href="https://www.postbank.bg/Personal-Data-PFBG-retailers"
                        target="_blank"
                        rel="noopener noreferrer"
                        >"GDPR" означава Регламент (ЕС) 2016/679...</a
                      >
                    </label>
                  </div>
                </div>
                <div id="jet-popup-step2-card" class="jet-popup-step" style="display: none;">
                  <div class="jet-popup-step2-body">
                    <div class="jet-popup-row">
                      <label class="jet-popup-label" for="jet-step2-firstname-card">Име *</label>
                      <input
                        type="text"
                        id="jet-step2-firstname-card"
                        class="jet-popup-input"
                        autocomplete="given-name"
                        required
                      >
                    </div>
                    <div class="jet-popup-row">
                      <label class="jet-popup-label" for="jet-step2-lastname-card">Фамилия *</label>
                      <input
                        type="text"
                        id="jet-step2-lastname-card"
                        class="jet-popup-input"
                        autocomplete="family-name"
                        required
                      >
                    </div>
                    <div class="jet-popup-row">
                      <label class="jet-popup-label" for="jet-step2-egn-card">ЕГН *</label>
                      <input
                        type="text"
                        id="jet-step2-egn-card"
                        class="jet-popup-input"
                        inputmode="numeric"
                        pattern="[0-9]{10}"
                        maxlength="10"
                        required
                      >
                    </div>
                    <div class="jet-popup-row">
                      <label class="jet-popup-label" for="jet-step2-phone-card">Мобилен телефон *</label>
                      <input type="tel" id="jet-step2-phone-card" class="jet-popup-input" autocomplete="tel" required>
                    </div>
                    <div class="jet-popup-row">
                      <label class="jet-popup-label" for="jet-step2-email-card">E-Mail *</label>
                      <input
                        type="email"
                        id="jet-step2-email-card"
                        class="jet-popup-input"
                        autocomplete="email"
                        required
                      >
                    </div>
                    <div class="jet-popup-divider"></div>
                    <div class="jet-popup-row">
                      <label class="jet-popup-checkbox-label">
                        <input type="checkbox" id="jet-step2-terms-checkbox-card" class="jet-popup-checkbox">
                        <a
                          href="https://www.postbank.bg/common-conditions-PFBG"
                          target="_blank"
                          rel="noopener noreferrer"
                          >Запознах се с условията за кандидатстване на ПБ Лични финанси *</a
                        >
                      </label>
                    </div>
                    <div class="jet-popup-row">
                      <a
                        href="https://www.postbank.bg/product-information-PBPG-retailers"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="jet-popup-link-text"
                        >Продуктова Информация на ПБ Лични финанси</a
                      >
                    </div>
                  </div>
                </div>
              </div>
              <div class="jet-popup-footer">
                <div id="jet-popup-footer-step1-card" class="jet-popup-footer-inner">
                  <div class="jet-popup-buttons">
                    <button type="button" id="jet-cancel-btn-card" class="jet-popup-btn">Откажи</button>
                    <button type="button" id="jet-add-to-cart-btn-card" class="jet-popup-btn">
                      Добави в количката
                    </button>
                    <button type="button" id="jet-buy-on-credit-btn-card" class="jet-popup-btn" disabled>
                      Купи на изплащане
                    </button>
                  </div>
                </div>
                <div
                  id="jet-popup-footer-step2-card"
                  class="jet-popup-footer-inner jet-popup-footer-step2"
                  style="display: none;"
                >
                  <div class="jet-popup-buttons jet-popup-buttons-left">
                    <button type="button" id="jet-step2-back-btn-card" class="jet-popup-btn">Назад</button>
                  </div>
                  <div class="jet-popup-buttons jet-popup-buttons-right">
                    <button type="button" id="jet-step2-cancel-btn-card" class="jet-popup-btn">Откажи</button>
                    <span class="jet-popup-submit-wrap" id="jet-step2-submit-wrap-card">
                      <button type="button" id="jet-step2-submit-btn-card" class="jet-popup-btn" disabled>
                        Изпрати
                      </button>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      {% else %}
        <div class="jet-product-error">
          <strong
            >За да може да бъде направена заявка за лизинг, е необходимо да попълните следните задължителни параметри в
            настройките на темата:</strong
          >
          <ul class="jet-product-error-list">
            {% unless jet_email_pbpf_valid %}
              <li>
                Попълнете коректно параметъра "Email ПБ Лични Финанси" с валиден email адрес (само един адрес). Това е
                задължително за изпращане на заявките към банката.
              </li>
            {% endunless %}
            {% unless jet_email_shop_valid %}
              <li>
                Попълнете коректно параметъра "Email на магазина" с валиден email адрес (само един адрес). Това е
                задължително за получаване на копие от заявките.
              </li>
            {% endunless %}
            {% unless jet_id_valid %}
              <li>
                Попълнете параметъра "Избери идентификатор на магазина за изпращане". Това е задължително за
                идентификация на магазина при банката.
              </li>
            {% endunless %}
          </ul>
        </div>
      {% endif %}
    {% endif %}
  {% endif %}
{% endif %}
